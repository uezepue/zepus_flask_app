{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">

    <h2>Welcome, {{ patient.name }} ðŸ‘‹</h2>

    <h3>Book Appointment</h3>
    <form id="appointment-form">
        <div class="form-group">
            <label>Choose Doctor:</label>
            <select name="doctor_id" id="doctor-select" required>
                <option value="">Select doctor</option>
                {% for doctor in doctors %}
                    <option value="{{ doctor.id }}">{{ doctor.name }} ({{ doctor.specialty }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Appointment Type:</label>
            <select name="appointment_type" required>
                <option value="general">General Consultation</option>
                <option value="followup">Follow-Up</option>
            </select>
        </div>

        <div class="form-group">
            <label>Consultation Mode:</label>
            <select name="consultation_mode" required>
                <option value="online">Online</option>
                <option value="in-person">In-Person</option>
                <option value="home">Home Visit</option>
            </select>
        </div>

        <button type="submit">Book Appointment</button>
    </form>

    <h3>Your Appointments</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Doctor</th>
                <th>Type</th>
                <th>Mode</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for appt in appointments %}
                <tr>
                    <td>{{ appt.doctor.name }}</td>
                    <td>{{ appt.appointment_type }}</td>
                    <td>{{ appt.consultation_mode }}</td>
                    <td>{{ appt.status }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<script>
// Handle appointment booking
document.getElementById('appointment-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const patientId = {{ patient.id }};
    const doctorId = document.getElementById('doctor-select').value;
    const appointmentType = this.appointment_type.value;
    const consultationMode = this.consultation_mode.value;

    const res = await fetch("/book-appointment", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            patient_id: patientId,
            doctor_id: doctorId,
            appointment_type: appointmentType,
            consultation_mode: consultationMode
        })
    });

    const data = await res.json();
    if (data.status === "success") {
        alert("Appointment booked successfully.");
        location.reload();
    } else {
        alert("Failed to book appointment.");
    }
});
</script>
{% endblock %}
